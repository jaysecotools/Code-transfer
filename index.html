<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Ecosystem Maintenance Tool | AHCECR301 Compliance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* Your CSS remains the same */
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
        }
        /* ... all your existing CSS ... */
        .fc-event-title {
            white-space: normal;
        }
        .fc-daygrid-event-dot {
            display: none;
        }
        
        /* Added for better mobile responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            .map-controls {
                position: relative;
                margin-bottom: 10px;
            }
            .btn-group-vertical {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <!-- Your HTML structure remains the same -->
    <div class="toast-container">
        <!-- Toast container -->
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <!-- ... your sidebar code ... -->
            
            <!-- Main Content -->
            <!-- ... your main content with all tabs ... -->
        </div>
    </div>

    <!-- All your modals remain the same -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        // Data storage and management
        const db = {
            assessments: JSON.parse(localStorage.getItem('assessments')) || [],
            species: JSON.parse(localStorage.getItem('species')) || [],
            activities: JSON.parse(localStorage.getItem('activities')) || [],
            monitoring: JSON.parse(localStorage.getItem('monitoring')) || [],
            reports: JSON.parse(localStorage.getItem('reports')) || [],
            complianceChecklist: JSON.parse(localStorage.getItem('complianceChecklist')) || [
                { id: 1, requirement: "Identified all relevant legislation", compliant: "", evidence: "", notes: "" },
                { id: 2, requirement: "Assessed impacts on protected matters", compliant: "", evidence: "", notes: "" },
                { id: 3, requirement: "Obtained necessary permits/approvals", compliant: "", evidence: "", notes: "" },
                { id: 4, requirement: "Implemented required protections", compliant: "", evidence: "", notes: "" },
                { id: 5, requirement: "Maintained required records", compliant: "", evidence: "", notes: "" }
            ],
            settings: JSON.parse(localStorage.getItem('settings')) || {
                siteName: "Blue Mountains Conservation Area",
                siteLocation: "NSW, Australia",
                siteArea: 125,
                siteDescription: "Mixed eucalypt forest with significant biodiversity values including several threatened species.",
                userProfile: {
                    name: "John Doe",
                    email: "john.doe@example.com",
                    role: "ecologist"
                }
            }
        };

        // Save data to localStorage with error handling
        function saveData() {
            try {
                localStorage.setItem('assessments', JSON.stringify(db.assessments));
                localStorage.setItem('species', JSON.stringify(db.species));
                localStorage.setItem('activities', JSON.stringify(db.activities));
                localStorage.setItem('monitoring', JSON.stringify(db.monitoring));
                localStorage.setItem('reports', JSON.stringify(db.reports));
                localStorage.setItem('complianceChecklist', JSON.stringify(db.complianceChecklist));
                localStorage.setItem('settings', JSON.stringify(db.settings));
                return true;
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                showToast('Error', 'Failed to save data. Local storage may be full or disabled.', 'error');
                return false;
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize components
            initCharts();
            initCalendar();
            loadDashboard();
            loadAssessments();
            loadSpecies();
            loadActivities();
            loadMonitoring();
            loadReports();
            loadComplianceChecklist();
            loadSettings();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize map after a slight delay to ensure DOM is fully rendered
            setTimeout(initMap, 100);
        });

        // Initialize map with error handling
        function initMap() {
            try {
                // Check if map container exists
                if (!document.getElementById('map')) {
                    console.error("Map container not found");
                    return;
                }
                
                // Initialize the map
                window.map = L.map('map').setView([-33.4000, 150.3000], 13);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.map);

                // Add a marker for the default location
                const marker = L.marker([-33.4000, 150.3000]).addTo(window.map)
                    .bindPopup('Blue Mountains Conservation Area')
                    .openPopup();

                // Add some sample zones (polygons)
                const zone1 = L.polygon([
                    [-33.41, 150.29],
                    [-33.41, 150.31],
                    [-33.39, 150.31],
                    [-33.39, 150.29]
                ], {color: 'blue', fillOpacity: 0.2}).addTo(window.map).bindPopup('Zone 1 - Native Forest');

                const zone2 = L.polygon([
                    [-33.42, 150.305],
                    [-33.42, 150.315],
                    [-33.40, 150.315],
                    [-33.40, 150.305]
                ], {color: 'green', fillOpacity: 0.2}).addTo(window.map).bindPopup('Zone 2 - Wetland Area');

                const zone3 = L.polygon([
                    [-33.38, 150.295],
                    [-33.38, 150.305],
                    [-33.36, 150.305],
                    [-33.36, 150.295]
                ], {color: 'red', fillOpacity: 0.2}).addTo(window.map).bindPopup('Zone 3 - Weed Control Area');

                // Create layer groups for different map features
                window.zonesLayer = L.layerGroup([zone1, zone2, zone3]);
                window.vegetationLayer = L.layerGroup();
                window.weedsLayer = L.layerGroup();

                // Add some sample vegetation points
                L.marker([-33.405, 150.302]).addTo(window.vegetationLayer)
                    .bindPopup('Eucalyptus pauciflora (Snow Gum)');
                L.marker([-33.404, 150.304]).addTo(window.vegetationLayer)
                    .bindPopup('Acacia melanoxylon (Blackwood)');
                L.marker([-33.406, 150.301]).addTo(window.vegetationLayer)
                    .bindPopup('Banksia marginata (Silver Banksia)');

                // Add some sample weed points
                L.marker([-33.365, 150.301]).addTo(window.weedsLayer)
                    .bindPopup('Rubus fruticosus (Blackberry)');
                L.marker([-33.364, 150.303]).addTo(window.weedsLayer)
                    .bindPopup('Lantana camara (Lantana)');
                L.marker([-33.366, 150.302]).addTo(window.weedsLayer)
                    .bindPopup('Ulex europaeus (Gorse)');

                // Add layer control
                const baseLayers = {
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }),
                    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    })
                };

                const overlays = {
                    "Zones": window.zonesLayer,
                    "Vegetation": window.vegetationLayer,
                    "Weeds": window.weedsLayer
                };

                L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(window.map);

                // Default to showing zones
                window.zonesLayer.addTo(window.map);

                // Button controls for map layers
                document.getElementById('zoneToggle').addEventListener('click', function() {
                    if (window.map.hasLayer(window.zonesLayer)) {
                        window.map.removeLayer(window.zonesLayer);
                        this.classList.remove('active');
                    } else {
                        window.map.addLayer(window.zonesLayer);
                        this.classList.add('active');
                    }
                });

                document.getElementById('vegetationToggle').addEventListener('click', function() {
                    if (window.map.hasLayer(window.vegetationLayer)) {
                        window.map.removeLayer(window.vegetationLayer);
                        this.classList.remove('active');
                    } else {
                        window.map.addLayer(window.vegetationLayer);
                        this.classList.add('active');
                    }
                });

                document.getElementById('weedsToggle').addEventListener('click', function() {
                    if (window.map.hasLayer(window.weedsLayer)) {
                        window.map.removeLayer(window.weedsLayer);
                        this.classList.remove('active');
                    } else {
                        window.map.addLayer(window.weedsLayer);
                        this.classList.add('active');
                    }
                });
            } catch (error) {
                console.error("Error initializing map:", error);
                document.getElementById('map').innerHTML = '<div class="alert alert-warning">Map could not be loaded. Please check your internet connection.</div>';
            }
        }

        // The rest of your JavaScript remains mostly the same, but with added error handling

        // Save assessment with improved validation
        function saveAssessment() {
            const form = document.getElementById('assessmentForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                validateComponents();
                return;
            }
            
            const selectedComponents = Array.from(document.querySelectorAll('input[name="components"]:checked')).map(cb => cb.value);
            if (selectedComponents.length === 0) {
                document.getElementById('componentsFeedback').style.display = 'block';
                return;
            }
            
            const threats = Array.from(document.getElementById('threats').selectedOptions).map(opt => opt.value);
            
            // Handle photo uploads
            const photoFiles = document.getElementById('assessmentPhotos').files;
            const photos = [];
            
            if (photoFiles.length > 0) {
                for (let i = 0; i < photoFiles.length; i++) {
                    if (photoFiles[i].type.match('image.*')) {
                        // In a real app, you would upload to a server
                        // For demo, we'll just store the file name
                        photos.push(photoFiles[i].name);
                    }
                }
            }
            
            const newAssessment = {
                id: Date.now(),
                date: document.getElementById('assessmentDate').value,
                assessor: document.getElementById('assessorName').value,
                description: document.getElementById('siteDescription').value,
                components: selectedComponents,
                health: document.getElementById('ecosystemHealth').value,
                threats: threats,
                photos: photos,
                createdAt: new Date().toISOString()
            };
            
            db.assessments.push(newAssessment);
            const saved = saveData();
            
            if (saved) {
                // Reset form
                form.reset();
                form.classList.remove('was-validated');
                document.getElementById('assessmentPhotoPreview').innerHTML = '';
                
                // Show success message
                showToast('Success', 'Assessment saved successfully!');
                
                // Reload assessments
                loadAssessments();
            }
        }

        // Add this function to handle image previews
        function handleImagePreview(inputElement, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            if (inputElement.files.length > 0) {
                for (let i = 0; i < inputElement.files.length; i++) {
                    const file = inputElement.files[i];
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.className = 'image-thumbnail';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        // Update your event listeners to use the new function
        function setupEventListeners() {
            // ... your existing event listeners ...
            
            // Assessment photo preview
            document.getElementById('assessmentPhotos').addEventListener('change', function(e) {
                handleImagePreview(this, 'assessmentPhotoPreview');
            });
            
            // Monitoring photo preview
            document.getElementById('monitoringPhotos').addEventListener('change', function(e) {
                handleImagePreview(this, 'monitoringPhotoPreview');
            });
            
            // ... rest of your event listeners ...
        }

        // The rest of your JavaScript remains the same

    </script>
</body>
</html>
